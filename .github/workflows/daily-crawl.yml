name: Daily News Crawl

on:
    # schedule:
    #   - cron: '0 0,4,8,12,16,20 * * *'  # Runs 6 times daily every 4 hours (00:00, 04:00, 08:00, 12:00, 16:00, 20:00 UTC)
    workflow_dispatch: # Manual trigger for testing
    # push:
    #     branches: [main] # Also run on pushes to main for testing

jobs:
    crawl-and-build:
        runs-on: ubuntu-latest
        timeout-minutes: 45 # Allow time(minutes) for model downloads

        permissions:
            contents: write # Allow pushing changes

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0 # Fetch full history to avoid detached HEAD

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'

            - name: Install dependencies
              run: |
                  npm ci
                  echo "Dependencies installed"

            - name: Install Playwright browsers
              run: |
                  npx playwright install --with-deps chromium

            - name: Create directories
              run: |
                  mkdir -p data
                  mkdir -p site
                  mkdir -p .cache
                  mkdir -p pdfs

            - name: Crawl RSS feeds
              run: |
                  echo "ü§ñ Starting RSS crawl..."
                  node scripts/crawl.js
                  echo "Crawl completed"

            - name: Optimize and validate
              run: |
                  # Validate JSON files
                  echo "üîç Validating data files..."
                  node -e "
                    const fs = require('fs');
                    try {
                      JSON.parse(fs.readFileSync('data/latest-raw.json'));
                      console.log('‚úÖ Data files valid');
                    } catch(e) {
                      console.error('‚ùå Invalid JSON:', e.message);
                      process.exit(1);
                    }
                  "

                  # Check if we have articles
                  ARTICLE_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('data/latest-raw.json')).articles.length)")
                  echo "üìä Found $ARTICLE_COUNT articles"

                  if [ "$ARTICLE_COUNT" -lt 10 ]; then
                    echo "‚ö†Ô∏è Warning: Low article count ($ARTICLE_COUNT)"
                  fi

            - name: Generate article PDFs
              run: npm run url-to-pdf

            - name: Configure Git
              run: |
                  git config --global user.email "zl-bot@users.noreply.github.com"
                  git config --global user.name "ZL Bot"
                  git config --global pull.rebase false
                  git config --global merge.tool false

            - name: Get current branch
              run: |
                  # Get the current branch name
                  BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
                  echo "Current branch: $BRANCH_NAME"
                  echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

                  # If in detached HEAD, try to checkout main branch
                  if [ "$BRANCH_NAME" = "HEAD" ]; then
                    echo "‚ùå Detached HEAD detected"
                    exit 1
                  fi

            - name: Configure Git
              run: |
                  git config --global user.email "zl-bot@users.noreply.github.com"
                  git config --global user.name "ZL Bot"
                  git config --global pull.rebase false
                  git config --global merge.tool false

            - name: Get current branch
              run: |
                  # Get the current branch name
                  BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
                  echo "Current branch: $BRANCH_NAME"
                  echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

                  # If in detached HEAD, try to checkout main branch
                  if [ "$BRANCH_NAME" = "HEAD" ]; then
                    echo "‚ùå Detached HEAD detected"
                    exit 1
                  fi

            - name: Commit and push changes
              run: |
                  # Ensure we're on the correct branch
                  git checkout $BRANCH_NAME

                  # Pull latest changes with conflict resolution
                  echo "Pulling latest changes..."
                  git pull origin $BRANCH_NAME --no-rebase || {
                    echo "Pull failed, checking status..."
                    git status
                    echo "Attempting to resolve conflicts..."
                    
                    # Try pull again
                    git pull origin $BRANCH_NAME --no-rebase || {
                      echo "Pull still failed, continuing with current state..."
                    }
                  }

                  # Add all changes
                  git add data/
                  git add pdfs/
                  git add -u  # Stage deletions

                  # Check if there are changes to commit
                  if git diff --staged --quiet; then
                    echo "‚ÑπÔ∏è No changes to commit - this is normal if no new articles were found"
                    exit 0  # Exit successfully, not as failure
                  fi

                  # Create commit message with stats
                  ARTICLE_COUNT=$(node -e "console.log(JSON.parse(require('fs').readFileSync('data/latest-raw.json')).articles.length)")
                  TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')

                  # Check what's being committed
                  echo "Changes to be committed:"
                  git status --short

                  git commit -m "ü§ñ Update news - $ARTICLE_COUNT articles - $TIMESTAMP"

                  # Push changes with retry logic
                  echo "Pushing changes..."
                  git push origin $BRANCH_NAME || {
                    echo "Push failed, trying with force-with-lease..."
                    git push origin $BRANCH_NAME --force-with-lease || {
                      echo "‚ùå Push failed even with force-with-lease"
                      echo "This might indicate a serious issue with the repository state"
                      exit 1
                    }
                  }

            - name: Report status
              run: |
                  echo "‚úÖ Workflow completed successfully!"
                  echo "üìä Statistics:"
                  node -e "
                    const data = JSON.parse(require('fs').readFileSync('data/latest-raw.json'));
                    console.log(`Articles: ${data.articles.length}`);
                  "

# Environment variables for the workflow
env:
    ENV_TEST: 'test' # a sample variable for testing
